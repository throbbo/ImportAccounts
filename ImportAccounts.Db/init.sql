IF EXISTS(SELECT * FROM sys.databases where name = DB_NAME() and snapshot_isolation_state = 0)
BEGIN
    declare @snapshotIsolation nvarchar(1000) = N'ALTER DATABASE ' + QUOTENAME(DB_NAME()) + ' SET ALLOW_SNAPSHOT_ISOLATION ON'
    exec sp_executesql @snapshotIsolation
END
go

IF EXISTS(SELECT * FROM sys.databases where name = DB_NAME() and is_read_committed_snapshot_on = 0)
BEGIN
    declare @readCommitted nvarchar(1000) = N'ALTER DATABASE ' + QUOTENAME(DB_NAME()) + ' SET READ_COMMITTED_SNAPSHOT ON'
    exec sp_executesql @readCommitted
END
go

IF EXISTS(SELECT * FROM sys.configurations WHERE name = 'clr enabled' and value = 0)
BEGIN
    exec sp_configure 'clr enabled', 1;
END
go

IF EXISTS(SELECT * FROM sys.configurations WHERE name = 'clr enabled' and value = 1 and value_in_use = 0)
BEGIN
    reconfigure
END
go

use master

IF NOT EXISTS (SELECT * FROM DBO.SYSLOGINS WHERE NAME = 'AtlasCLRLogin')
BEGIN
    CREATE ASSEMBLY [SqlJsonSafe]
    FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300A57C29560000000000000000E00002210B010B00000800000006000000000000DE270000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000050990000030040850000100000100000000010000010000000000000100000000000000000000000902700004B000000004000001803000000000000000000000000000000000000006000000C000000582600001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000E4070000002000000008000000020000000000000000000000000000200000602E72737263000000180300000040000000040000000A0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000000E00000000000000000000000000004000004200000000000000000000000000000000C0270000000000004800000002000500D0200000880500000900000000000000000000000000000050200000800000000000000000000000000000000000000000000000000000000000000000000000CD4B1A08D9E29CBC608DE895E9B18206AEDA842EAE7551E47940EED6C3A73175744D3AC4BF0493A8CBF375EEF98FBDDB72BCA38E2EE1561698B80157368141725DCE48532C8CC7CFB8956AD70770C1CAF5FFF084491DFFC3059A11F92C653AE33BC8706F82D3BBE792BAE075C700DFD9142461CA559DBB3225CC72FD1F2CB21542534A4201000100000000000C00000076322E302E35303732370000000005006C00000080010000237E0000EC0100002802000023537472696E6773000000001404000008000000235553001C0400001000000023475549440000002C0400005C01000023426C6F620000000000000002000001071400000900000000FA2533001600000100000010000000010000000F0000000D000000010000000100000000000A0001000000000006003500230006005200230006006F00230006008E0023000600A70023000600C00023000600DB0023000600F600230006002E010F01060042010F010600500123000600690123000600990186013700AD0100000600DC01BC010600FC01BC01000000000100000000000100010009004C000A0011004C000A0019004C000A0021004C000A0029004C000A0031004C000A0039004C000A0041004C000A0049004C000F0051004C000A0059004C000A0061004C000A0069004C00140079004C001A0081004C001F002E000B00C5002E001300D6002E001B00D6002E002300D6002E002B00C5002E003300DC002E003B00D6002E004B00D6002E005300F4002E0063001E012E006B002B012E00730034012E007B003D010480000001000000000000000100000023001A02000002000000000000000000000001001A00000000000000003C4D6F64756C653E0053716C4A736F6E536166652E646C6C006D73636F726C69620053797374656D2E5265666C656374696F6E00417373656D626C795469746C65417474726962757465002E63746F7200417373656D626C794465736372697074696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C7943756C747572654174747269627574650053797374656D2E52756E74696D652E496E7465726F70536572766963657300436F6D56697369626C65417474726962757465004775696441747472696275746500417373656D626C7956657273696F6E41747472696275746500417373656D626C7946696C6556657273696F6E4174747269627574650053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053716C4A736F6E536166650000000003200000000000751E63D5C3F2F243B540C8B5601B33690008B77A5C561934E089042001010E042001010205200101113904200101080320000180A00024000004800000940000000602000000240000525341310004000001000100996D0A68CD935C7D79ACEDF282058F8724ED4DD4628AB21DA178BBA6CF59C07FAF1852A58931B2776F041D5977C793203FA3D372102835E2F697407BB6A1A40792F7FF1DBB70F4D119C21FEBF0F15B09E0FC2E66AFC3FA7BF997F02F7053A0B0F17B83C052056224FC2AA5142A586F4353D0CB751275C92E7601E5247CC9E8BF1001000B53716C4A736F6E53616665000005010000000017010012436F7079726967687420C2A920203230313500002901002462303939356135382D623737652D346235662D383464332D37323566396630366235656300000C010007312E302E302E3000000801000200000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730100000000A57C295600000000020000001C01000074260000740800005253445316C85C55FD36F24490F836B9DE9E535801000000643A5C4465765C73716C6A736F6E5C7372635C53716C4A736F6E536166655C6F626A5C52656C656173655C53716C4A736F6E536166652E70646200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B82700000000000000000000CE270000002000000000000000000000000000000000000000000000C02700000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000C00200000000000000000000C00234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00420020000010053007400720069006E006700460069006C00650049006E0066006F000000FC010000010030003000300030003000340062003000000040000C000100460069006C0065004400650073006300720069007000740069006F006E0000000000530071006C004A0073006F006E0053006100660065000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E003000000040001000010049006E007400650072006E0061006C004E0061006D0065000000530071006C004A0073006F006E0053006100660065002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003100350000004800100001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530071006C004A0073006F006E0053006100660065002E0064006C006C00000038000C000100500072006F0064007500630074004E0061006D00650000000000530071006C004A0073006F006E0053006100660065000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000E03700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    WITH PERMISSION_SET = SAFE

    CREATE ASYMMETRIC KEY AtlasCLRKey FROM ASSEMBLY [SqlJsonSafe]
    DROP ASSEMBLY [SqlJsonSafe]
    CREATE LOGIN AtlasCLRLogin FROM ASYMMETRIC KEY AtlasCLRKey
    GRANT UNSAFE ASSEMBLY TO AtlasCLRLogin
END
go